# lko-datastructure 已实现需求

## 一、数学计算模块

### 1. Ratio 类
- **构造方法**：创建比率对象
- **interpolate(a: Float, b: Float)**: 根据比率在a和b之间进行插值计算
- **clamp(lower: Ratio, upper: Ratio)**: 将比率限制在指定范围内
- **coerceIn(lower: Ratio, upper: Ratio)**: 将比率强制限制在指定范围内
- **coerceIn(lower: Float, upper: Float)**: 将比率强制限制在浮点范围内
- **coerceIn(range: ClosedFloatingPointRange<Float>)**: 将比率强制限制在闭区间范围内
- **toFloat()**: 将比率转换为浮点数值

### 2. Vector2 类
- **构造方法**: 创建二维向量 (x, y)
- **插值相关方法**: 
  - interpolateTo(end: Vector2, ratio: Ratio): Vector2 - 插值到目标向量
- **比较相关方法**: 
  - isAlmostEquals(other: Vector2, epsilon: Float): Boolean - 判断向量是否近似相等
  - equals(other: Any?): Boolean - 向量相等性判断
  - hashCode(): Int - 哈希码生成
- **操作符重载**: 
  - plus(other: Vector2): Vector2 - 向量加法
  - plus(other: Float): Vector2 - 向量与标量加法
  - minus(other: Vector2): Vector2 - 向量减法
  - minus(other: Float): Vector2 - 向量与标量减法
  - times(other: Vector2): Vector2 - 向量乘法
  - times(other: Float): Vector2 - 向量与标量乘法
  - div(other: Vector2): Vector2 - 向量除法
  - div(other: Float): Vector2 - 向量与标量除法
- **伴生对象常量**: 
  - ZERO: 零向量 (0, 0)
  - UNIT: 单位向量 (1, 1)
  - UNIT_X: X轴单位向量 (1, 0)
  - UNIT_Y: Y轴单位向量 (0, 1)

### 3. Vector3 类
- **构造方法**: 创建三维向量 (x, y, z)
- **操作符重载**: 
  - div(other: Vector3): Vector3 - 向量除法
  - div(other: Float): Vector3 - 向量与标量除法
- **伴生对象常量**: 
  - Zero: 零向量 (0, 0, 0)

### 4. Vector4 类
- **构造方法**: 创建四维向量 (x, y, z, w)
- **插值相关方法**: 
  - interpolateTo(end: Vector4, ratio: Ratio): Vector4 - 插值到目标向量
- **操作符重载**: 
  - plus(other: Vector4): Vector4 - 向量加法
  - plus(other: Float): Vector4 - 向量与标量加法
  - minus(other: Vector4): Vector4 - 向量减法
  - minus(other: Float): Vector4 - 向量与标量减法
  - times(other: Vector4): Vector4 - 向量乘法
  - times(other: Float): Vector4 - 向量与标量乘法
  - div(other: Vector4): Vector4 - 向量除法
  - div(other: Float): Vector4 - 向量与标量除法
  - Float.div(other: Vector4): Vector4 - 标量与向量除法
- **扩展方法**: 
  - max(other: Vector4): Vector4 - 向量各分量取最大值
  - toVector4(): Vector4 - 转换为Vector4类型
- **伴生对象常量**: 
  - ZERO: 零向量 (0, 0, 0, 0)
  - ONE: 单位向量 (1, 1, 1, 1)

### 5. Matrix3 类
- **构造方法**: 创建3x3矩阵
- **属性访问器**: 
  - v00, v01, v02, v10, v11, v12, v20, v21, v22: 矩阵元素访问
  - transpose: 矩阵转置
  - column1, column2, column3: 矩阵列向量
  - rows: 矩阵行向量序列
- **操作符重载**: 
  - plus(other: Matrix3): Matrix3 - 矩阵加法
  - minus(other: Matrix3): Matrix3 - 矩阵减法
  - times(other: Matrix3): Matrix3 - 矩阵乘法
  - times(other: Float): Matrix3 - 矩阵与标量乘法
  - div(other: Matrix3): Matrix3 - 矩阵除法
  - div(other: Float): Matrix3 - 矩阵与标量除法
- **转换方法**: 
  - toFloatArray(): FloatArray - 转换为浮点数组

### 6. Matrix4 类
- **构造方法**: 创建4x4矩阵，使用FloatArray(16)存储
- **属性访问器**: 
  - v00, v01, v02, v03, v10, v11, v12, v13, v20, v21, v22, v23, v30, v31, v32, v33: 矩阵元素访问
  - transpose: 矩阵转置
  - column1, column2, column3, column4: 矩阵列向量
  - rows: 矩阵行向量序列
- **操作符重载**: 
  - plus(other: Matrix4): Matrix4 - 矩阵加法
  - minus(other: Matrix4): Matrix4 - 矩阵减法
  - times(other: Matrix4): Matrix4 - 矩阵乘法
  - times(other: Vector4): Vector4 - 矩阵与向量乘法
- **伴生对象方法**: 
  - identity(): Matrix4 - 创建单位矩阵
  - lookAt(eye: Vector3, target: Vector3, up: Vector3): Matrix4 - 创建视图矩阵
- **伴生对象常量**: 
  - zero: 零矩阵
  - identity: 单位矩阵

### 7. 矩阵变换扩展
- **Matrix3.transform(vector: Vector2): Vector2**: 使用3x3矩阵变换2D向量
- **Matrix4.transform(vector: Vector3): Vector3**: 使用4x4矩阵变换3D点向量

## 二、BVH (Bounding Volume Hierarchy) 模块

### 1. BVH 基类
- **构造方法**: BVH(dimensions: Int) - 创建指定维度的BVH树
- **插入方法**: 
  - insert(value: T, block: BVHRect.() -> Unit): Boolean - 插入对象及其包围盒
  - bulkInsert(items: Sequence<T>, block: T.(BVHRect) -> Unit): Int - 批量插入多个对象
- **删除方法**: 
  - remove(value: T): Boolean - 从BVH中删除对象
  - clear(): Unit - 清空BVH树
- **更新方法**: 
  - update(value: T, block: BVHRect.() -> Unit): Boolean - 更新对象的包围盒
- **查询方法**: 
  - searchValues(block: BVHRect.() -> Unit): List<T> - 搜索与指定区域相交的所有对象
  - intersect(block: BVHRay.() -> Unit): List<BVHIntersection<T>> - 射线相交测试
- **属性与工具方法**: 
  - size: Int - 获取BVH中对象数量
  - isEmpty(): Boolean - 判断BVH是否为空
  - computeDepth(): Int - 计算BVH树深度
  - iterator(): Iterator<T> - 获取BVH中所有对象的迭代器

### 2. BVH2 类（2D空间适配器）
- **构造方法**: BVH2<T>() - 创建二维BVH
- **插入方法**: 
  - insert(rect: Rectangle, value: T): Boolean - 插入带矩形包围盒的对象
  - bulkInsert(item: Sequence<T>, provider: T.() -> Rectangle): Int - 批量插入对象
- **删除方法**: 
  - remove(value: T): Boolean - 从BVH2中删除对象
  - clear(): Unit - 清空BVH2树
- **更新方法**: 
  - update(rect: Rectangle, value: T): Boolean - 更新对象的矩形包围盒
- **查询方法**: 
  - searchValuesByRect(rect: Rectangle, result: MutableList<T>): List<T> - 搜索与指定矩形相交的对象
  - searchValuesByRect(minX: Float, minY: Float, maxX: Float, maxY: Float, result: MutableList<T>): List<T> - 搜索与指定矩形范围相交的对象
  - searchValuesByRay(origin: Point, direction: Vector2, result: MutableList<T>): List<T> - 搜索与射线相交的对象
- **属性**: 
  - rectangle: Rectangle - 获取整个BVH2的边界矩形
  - size: Int - 获取BVH2中对象数量
  - isEmpty(): Boolean - 判断BVH2是否为空

### 3. BVH3 类（3D空间适配器）
- **构造方法**: BVH3<T>() - 创建三维BVH
- **插入方法**: 
  - insert(min: Vector3, max: Vector3, value: T): Boolean - 使用最小/最大点插入对象
  - bulkInsert(item: Sequence<T>, provider: T.() -> Pair<Vector3, Vector3>): Int - 批量插入对象
- **删除方法**: 
  - remove(value: T): Boolean - 从BVH3中删除对象
- **更新方法**: 
  - update(min: Vector3, max: Vector3, value: T): Boolean - 更新对象的立方体包围盒
  - update(minX: Float, minY: Float, minZ: Float, maxX: Float, maxY: Float, maxZ: Float, value: T): Boolean - 更新对象的立方体范围
- **查询方法**: 
  - searchValuesByBox(min: Vector3, max: Vector3, result: MutableList<T>): List<T> - 搜索与指定立方体相交的对象
  - searchValuesByBox(minX: Float, minY: Float, minZ: Float, maxX: Float, maxY: Float, maxZ: Float, result: MutableList<T>): List<T> - 搜索与指定立方体范围相交的对象
  - searchValuesByRay(origin: Vector3, direction: Vector3, result: MutableList<T>): List<T> - 搜索与射线相交的对象
- **属性**: 
  - size: Int - 获取BVH3中对象数量
  - isEmpty(): Boolean - 判断BVH3是否为空

### 4. BVHRay 类
- **构造方法**: BVHRay(originOffset: Int, directionOffset: Int) - 创建射线对象
- **属性访问器**: 
  - originOffset: Int - 射线原点在数据数组中的偏移
  - directionOffset: Int - 射线路径在数据数组中的偏移
- **访问器方法**: 
  - origin(bvh: BVH<*>, dimension: Int): Float - 获取射线原点在指定维度的值
  - origin(bvh: BVH<*>, dimension: Int, value: Float): Unit - 设置射线原点在指定维度的值
  - direction(bvh: BVH<*>, dimension: Int): Float - 获取射线路径在指定维度的值
  - direction(bvh: BVH<*>, dimension: Int, value: Float): Unit - 设置射线路径在指定维度的值
- **归一化方法**: 
  - normalize(bvh: BVH<*>): BVHRay - 归一化射线路径方向

### 5. BVHRect 类
- **维度访问方法**: 
  - min(bvh: BVH<*>, dimension: Int): Float - 获取矩形在指定维度的最小值
  - min(bvh: BVH<*>, dimension: Int, value: Float): Unit - 设置矩形在指定维度的最小值
  - max(bvh: BVH<*>, dimension: Int): Float - 获取矩形在指定维度的最大值
  - max(bvh: BVH<*>, dimension: Int, value: Float): Unit - 设置矩形在指定维度的最大值
  - size(bvh: BVH<*>, dimension: Int): Float - 获取矩形在指定维度的大小

## 三、数据结构优化

### 1. 值类型优化
- 大量使用 `value class` + `@JvmInline` 注解，减少对象分配和内存占用
- 主要应用于：Vector2、Vector3、Vector4、Matrix3、Matrix4、BVH2、BVH3、BVHRay 等

### 2. JVM 签名冲突解决
- 通过巧妙设计函数签名和使用伴生对象方法，解决了在 JVM 平台上的方法签名冲突问题
- 例如 Matrix4 类的 lookAt 方法提供了多个重载版本

### 3. 内存优化
- 使用 `FloatFastList`、`IntFastList` 和 `ObjectFastList` 等自定义集合类，减少内存分配和垃圾回收压力
- BVH 实现中复用节点偏移（`recycledNodeIds`），减少临时对象创建

## 四、跨平台支持

### 1. Kotlin Multiplatform 支持
- 项目基于 Kotlin Multiplatform 开发，支持在 JVM、JavaScript 和原生平台上运行
- 使用 `commonMain` 源代码集编写共享代码

### 2. 平台特定优化
- 通过 `@JvmInline` 等注解提供 JVM 平台特定的优化
- 确保在不同平台上保持一致的 API 和行为

### 3. 数学库兼容性
- 提供了与各种数学库的兼容接口，如与 LibGDX 数学库的互操作性