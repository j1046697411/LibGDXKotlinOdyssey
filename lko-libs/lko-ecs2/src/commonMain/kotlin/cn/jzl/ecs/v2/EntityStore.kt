package cn.jzl.ecs.v2

/**
 * EntityStore - 实体存储接口
 * 
 * 核心职责：
 * - 提供实体ID和版本的管理
 * - 支持实体的创建、查询和销毁
 * - 维护活动实体的集合
 * - 确保实体ID的唯一性和版本控制
 * 
 * 实体存储是ECS框架中实体生命周期管理的基础，它负责分配唯一的实体ID，
 * 管理版本号以防止悬挂引用，并提供高效的实体查询机制。
 */
interface EntityStore {

    /**
     * 获取当前存储的实体数量
     * 
     * @return 活动实体的数量
     */
    val size: Int

    /**
     * 获取所有活动实体的序列
     * 
     * @return 实体序列
     */
    val entities: Sequence<Entity>

    /**
     * 创建一个新的实体，自动分配ID
     * 
     * 实现逻辑：
     * 1. 从可用ID池获取下一个可用的实体ID
     * 2. 为该ID分配一个新的版本号（通常从1开始）
     * 3. 创建并返回包含ID和版本的实体对象
     * 4. 将新实体添加到活动实体集合中
     * 
     * 这个方法确保了实体ID的唯一性，并通过版本控制防止悬挂引用问题。
     * 
     * @return 新创建的实体
     */
    fun create(): Entity

    /**
     * 使用指定ID创建实体
     * 
     * 实现逻辑：
     * 1. 验证指定ID的合法性和可用性
     * 2. 为该ID分配适当的版本号（如果ID已使用过则递增版本号）
     * 3. 创建并返回包含指定ID和分配版本的实体对象
     * 4. 将新实体添加到活动实体集合中
     * 
     * 这个方法允许精确控制实体ID，适用于需要预定义实体标识的场景，
     * 但需要注意避免ID冲突和版本管理问题。
     * 
     * @param id 指定的实体ID
     * @return 使用指定ID创建的实体
     */
    fun create(id: Int): Entity

    /**
     * 检查实体是否存在于存储中 - 实现contains运算符
     * 
     * 实现逻辑：
     * 1. 检查实体ID是否在活动实体范围内
     * 2. 验证实体的版本号是否与存储中记录的版本匹配
     * 3. 如果两个条件都满足，则实体存在且有效
     * 
     * 版本检查是防止悬挂引用的关键机制，确保即使实体ID被重用，
     * 旧的实体引用也无法访问新实体。
     * 
     * @param entity 要检查的实体
     * @return 如果实体存在且版本匹配返回true
     */
    operator fun contains(entity: Entity): Boolean

    /**
     * 通过ID获取实体 - 实现get运算符
     * 
     * 实现逻辑：
     * 1. 检查指定ID是否存在于活动实体集合中
     * 2. 如果存在，返回包含该ID和当前版本的实体对象
     * 3. 如果不存在，可能抛出异常或返回特殊的无效实体
     * 
     * 这个方法提供了快速访问已知ID实体的途径，通常用于从持久化数据重建实体。
     * 
     * @param entityId 实体ID
     * @return 对应的实体
     */
    operator fun get(entityId: Int): Entity

    /**
     * 从存储中移除实体 - 实现minusAssign运算符
     * 
     * 实现逻辑：
     * 1. 验证实体是否存在且有效（ID和版本匹配）
     * 2. 从活动实体集合中移除该实体
     * 3. 递增该ID的版本号，使所有旧引用失效
     * 4. 将ID加入可用ID池（如果支持ID重用）
     * 
     * 这个方法确保了实体的正确移除，并通过版本递增机制防止悬挂引用。
     * 
     * @param entity 要移除的实体
     */
    operator fun minusAssign(entity: Entity)

    /**
     * 清空存储中的所有实体
     * 
     * 实现逻辑：
     * 1. 遍历并移除所有活动实体
     * 2. 重置所有实体ID的版本号
     * 3. 将所有ID加入可用ID池
     * 4. 清空活动实体集合
     * 
     * 这个方法用于完全重置实体系统，通常在场景切换或游戏重启时使用。
     * 它确保了系统资源的完全释放和状态的干净重置。
     */
    fun clear()
}