# 文字游戏项目需求文档

## 文档概览

| 项目信息 | 详情 |
|---------|------|
| **项目类型** | 文字冒险游戏 |
| **核心框架** | ECS (Entity Component System) |
| **主要功能** | AI角色系统、宗门管理、资源系统 |
| **开发状态** | 需求分析阶段 |
| **文档版本** | v2.1 (修正版) |
| **更新日期** | 2025-12-21 |
| **编写人** | AI Assistant |

## 快速导航

### 核心系统
- 玩家交互系统 - 玩家与游戏世界的互动方式
- AI角色系统 - 角色自主决策和行为控制
- 宗门管理系统 - 资源管理和设施建设
- 道具系统 - 物品管理和流通交易
- 试炼系统 - 高级材料获取途径
- 功法系统 - 修炼和战斗技能管理
- 地图系统 - 区域管理和占领机制

### 技术实现
- 技术架构 - 系统架构和组件设计
- 实现计划 - 开发阶段和里程碑

## 详细目录
- [1. 项目概述](#1-项目概述)
- [2. 功能需求](#2-功能需求)
  - [2.1 玩家交互系统](#21-玩家交互系统)
  - [2.2 AI角色系统](#22-ai角色系统)
  - [2.3 宗门管理系统](#23-宗门管理系统)
  - [2.4 道具系统](#24-道具系统)
  - [2.5 试炼系统](#25-试炼系统)
  - [2.6 功法系统](#26-功法系统)
  - [2.7 地图系统](#27-地图系统)
  - [2.8 核心系统交互关系](#28-核心系统交互关系)
  - [2.9 非功能需求](#29-非功能需求)
- [3. 技术架构](#3-技术架构)
  - [3.1 ECS框架使用](#31-ecs框架使用)
  - [3.2 主要组件设计](#32-主要组件设计)
  - [3.3 主要系统设计](#33-主要系统设计)
- [4. 实现计划](#4-实现计划)
- [5. 验收标准](#5-验收标准)
- [6. 技术栈](#6-技术栈)
- [7. 预期交付时间](#7-预期交付时间)
- [8. 风险评估](#8-风险评估)

---

## 1. 项目概述

### 1.1 项目背景
本项目旨在基于现有的ECS（Entity Component System）框架（lko-ecs4）开发一款文字冒险游戏，重点实现AI角色系统和宗门基础世界，为玩家提供沉浸式的文字游戏体验。

### 1.2 项目目标
- 创建一个基于ECS框架的文字游戏核心引擎
- 实现可运行的AI角色系统，支持角色自主决策和行为
- 构建宗门基础世界，包括宗门结构、资源管理和发展机制
- 提供简洁的文字界面，支持玩家与游戏世界的交互

### 1.3 目标用户
- 18-35岁的文字游戏爱好者
- 喜欢策略和角色扮演游戏的玩家
- 对东方玄幻题材感兴趣的用户
- 喜欢深度剧情和角色发展的玩家
- 具备一定阅读能力和想象能力的用户

## 2. 功能需求

### 2.1 玩家交互系统
玩家交互系统定义了玩家如何与游戏世界进行互动，包括玩家角色定位、交互界面、操作方式和成长路径。

#### 2.1.1 玩家角色定位
玩家可以选择不同的游戏模式，体验不同的游戏内容：

**掌门模式**：玩家扮演宗门掌门，拥有最高决策权
- 全权管理宗门事务，制定发展战略
- 任命长老，分配资源，处理重大事件
- 与其他宗门进行外交和贸易

**长老模式**：玩家扮演特定长老，负责专项事务管理
- 执法长老：维护宗门纪律，处理违规事件
- 炼丹长老：管理丹药炼制和分配
- 炼器长老：负责装备打造和维护
- 传功长老：传授功法，指导弟子修炼
- 财务长老：管理宗门财务和资源分配

**弟子模式**：玩家扮演普通弟子，从底层开始成长
- 外门弟子：完成基础任务，积累贡献点
- 内门弟子：参与重要任务，使用宗门设施
- 亲传弟子：接受长老指导，参与宗门决策

**观察者模式**：玩家作为观察者，不直接参与管理
- 观察AI角色行为，了解宗门运作
- 分析游戏数据，制定策略

#### 2.1.2 交互界面设计
游戏提供多种交互界面，支持不同的操作需求：

**文字界面**：基于命令行的文字交互界面
- 命令格式：`动作 [目标] [参数]`
- 支持命令补全和快捷键
- 提供上下文相关的帮助信息

**状态显示**：实时显示宗门状态、资源状况、角色信息
- 宗门概况：弟子数量、资源总量、设施状况
- 个人状态：修为、贡献点、职务、装备
- 事件提醒：重要事件、任务提醒、危机预警

**事件日志**：记录重要事件和决策结果
- 按时间顺序显示事件
- 支持按类型筛选事件
- 提供事件详情和影响分析

**操作菜单**：分层级的操作菜单系统
- 主菜单：宗门管理、个人修炼、任务系统
- 子菜单：资源分配、设施建设、弟子管理
- 快捷操作：常用功能的快捷访问

#### 2.1.3 玩家与游戏系统交互

**与AI管理层交互**
- **指令下达**：玩家向AI角色下达指令
  - 直接指令：指定具体任务和目标
  - 策略指令：设定长期目标和优先级
  - 授权指令：授权AI角色自主决策
- **决策参与**：玩家参与宗门重大决策
  - 投票表决：根据职务权重参与投票
  - 建议提出：向管理层提出建议
  - 危机处理：参与处理突发事件
- **角色互动**：玩家与AI角色建立关系
  - 师徒关系：拜师学艺，传授功法
  - 同门关系：合作完成任务，建立友谊
  - 竞争关系：与其他角色竞争资源

**与资源系统交互**
- **资源管理**：玩家参与资源分配和使用
  - 资源查看：查看各类资源库存和流动
  - 资源分配：分配资源给不同部门和角色
  - 资源交易：与其他宗门进行资源交易
- **贡献点使用**：玩家使用贡献点获取资源
  - 兑换灵石：将贡献点兑换为灵石
  - 购买物品：用贡献点购买丹药、装备
  - 使用设施：消耗贡献点使用宗门设施

**与地图/试炼系统交互**
- **区域探索**：玩家探索和占领游戏区域
  - 区域查看：查看区域资源、设施、敌人
  - 区域占领：派遣弟子占领新区域
  - 区域开发：建设设施，提高资源产出
- **试炼参与**：玩家参与各种试炼活动
  - 个人试炼：提升个人修为和装备
  - 团队试炼：带领弟子团队完成试炼
  - 宗门试炼：参与宗门组织的集体试炼

#### 2.1.4 玩家成长路径
玩家可以通过多种方式提升自身实力和地位：

**修为提升**：通过修炼提升个人实力
- 基础修炼：日常打坐修炼
- 功法学习：学习不同等级的功法
- 丹药辅助：使用丹药加速修炼

**职务晋升**：通过贡献和实力获得晋升
- 贡献积累：完成宗门任务获得贡献点
- 实力要求：达到相应修为等级
- 长老认可：获得现任长老的推荐

**技能发展**：发展个人专长技能
- 炼丹技能：炼制高品质丹药
- 炼器技能：打造强力装备
- 战斗技能：提升战斗能力

#### 2.1.5 玩家交互系统技术实现

**交互系统架构**
```
[玩家输入] → [命令解析器] → [权限验证] → [动作执行器] → [结果反馈]
     ↓              ↓              ↓              ↓              ↓
[界面层]      [逻辑层]      [安全层]      [业务层]      [显示层]
```

**命令系统实现**
- **命令格式**：`动作 [目标] [参数]`
  - 动作：操作类型（查看、分配、建设、修炼等）
  - 目标：操作对象（资源、角色、设施等）
  - 参数：操作参数（数量、时间、优先级等）
- **命令解析**：
  - 正则表达式匹配命令格式
  - 上下文敏感的命令补全
  - 参数类型验证和转换
- **权限验证**：
  - 基于玩家角色的权限检查
  - 操作目标的可访问性验证
  - 资源使用限制检查

**界面系统实现**
- **状态显示组件**：
  - 实时数据更新机制
  - 条件触发的事件提醒
  - 多层级的信息展示
- **菜单系统**：
  - 树状结构的菜单导航
  - 快捷键绑定和自定义
  - 上下文相关的菜单项
- **日志系统**：
  - 时间戳的事件记录
  - 分类存储和检索
  - 影响分析和统计

**交互数据流**
```
玩家输入 → 命令解析 → 权限验证 → 业务逻辑 → 数据更新 → 界面刷新
     ↓         ↓         ↓         ↓         ↓         ↓
[UI事件]  [语法分析]  [安全检查]  [游戏逻辑]  [状态变更]  [视觉反馈]
```

**技术实现要点**
- **响应式设计**：界面实时响应游戏状态变化
- **异步处理**：长时间操作使用异步执行
- **错误处理**：完善的错误提示和恢复机制
- **性能优化**：大数据量的分页和懒加载
- **扩展性**：模块化设计支持功能扩展

**与ECS框架集成方案**
- **玩家实体组件**：
  - `PlayerComponent`：玩家身份标识和权限信息
  - `RoleComponent`：玩家当前角色类型和权限级别
  - `CommandComponent`：玩家输入的命令队列
  - `UIStateComponent`：界面状态和显示配置
- **交互系统**：
  - `InputSystem`：处理玩家输入和命令解析
  - `UISystem`：管理界面显示和状态更新
  - `PermissionSystem`：验证玩家操作权限
  - `FeedbackSystem`：生成操作结果反馈
- **数据流集成**：
  - 玩家操作通过ECS事件系统传递
  - 游戏状态变化通过组件更新反映到界面
  - 异步操作使用ECS的协程系统处理

**具体实现示例**
```kotlin
// 玩家命令组件
class CommandComponent : Component {
    val commandQueue = mutableListOf<GameCommand>()
    var currentCommand: GameCommand? = null
    var commandState = CommandState.IDLE
}

// 玩家权限组件
class PermissionComponent : Component {
    var roleType: PlayerRole = PlayerRole.DISCIPLE
    var permissions: Set<Permission> = emptySet()
    var resourceLimits: Map<ResourceType, Int> = emptyMap()
}

// 输入处理系统
class InputSystem : IteratingSystem(
    Family.all(PlayerComponent::class.java, CommandComponent::class.java).get()
) {
    override fun processEntity(entity: Entity, deltaTime: Float) {
        val commandComp = entity.getComponent(CommandComponent::class.java)
        // 处理玩家输入命令
        processPlayerInput(commandComp)
    }
}
```

**交互流程详细设计**

**命令处理流程**
1. **输入接收**：玩家输入命令文本
2. **语法解析**：解析命令格式和参数
3. **权限验证**：检查玩家是否有执行权限
4. **资源检查**：验证所需资源是否充足
5. **执行操作**：调用对应的业务逻辑
6. **结果反馈**：生成操作结果和界面更新

**错误处理机制**
- **语法错误**：命令格式不正确，提示正确用法
- **权限错误**：玩家权限不足，提示所需权限
- **资源错误**：资源不足，显示当前资源状况
- **逻辑错误**：操作条件不满足，提示具体原因
- **系统错误**：内部错误，记录日志并提示重试

**界面更新策略**
- **实时更新**：关键状态变化立即刷新界面
- **批量更新**：非关键变化累积后批量更新
- **条件更新**：满足特定条件时触发更新
- **用户触发**：玩家主动刷新界面

**性能优化措施**
- **命令缓存**：常用命令结果缓存
- **数据分页**：大数据量时分页显示
- **懒加载**：界面元素按需加载
- **异步处理**：耗时操作异步执行

### 2.2 AI角色系统
AI角色系统是游戏的核心，负责控制宗门内所有角色的自主决策和行为。系统采用层级管理结构，确保角色行为的合理性和多样性。

#### 2.2.1 角色层级结构
```
┌─────────────────────────────────────────────────────────────┐
│                       掌门 (Sect Leader)                    │
│  (最高决策者，全权管理宗门事务)                             │
└─────────────────────────────┬─────────────────────────────┘
                              │
                              ▼
┌─────────────┬─────────────┬─────────────┬─────────────┐
│ 执法长老    │ 炼丹长老    │ 炼器长老    │ 传功长老    │ 财务长老    │
│ (Law Elder) │ (Alchemy)   │ (Crafting)  │ (Teaching)  │ (Finance)   │
└─────────────┴─────────────┴─────────────┴─────────────┘
                              │
                              ▼
┌─────────────┬─────────────┬─────────────┬─────────────┐
│ 亲传弟子     │ 内门弟子     │ 外门弟子     │ 杂役/普通人  │
│ (Core Disc) │ (Inner Disc)│ (Outer Disc)│ (Laborers)  │
└─────────────┴─────────────┴─────────────┴─────────────┘
```

#### 2.2.2 AI决策流程
```
角色状态感知 → 需求分析 → 目标设定 → 行动规划 → 执行行动
     ↓              ↓          ↓          ↓          ↓
环境信息     资源状况     优先级排序   可行性评估   结果反馈
```

#### 2.2.3 角色属性体系

| 属性类别 | 属性名称 | 作用说明 | 数值范围 |
|---------|---------|---------|---------|
| **基本属性** | 修为境界 | 角色实力等级 | 炼气→筑基→金丹→元婴→化神 |
| | 年龄 | 角色年龄，影响寿命和潜力 | 15-500岁 |
| | 性别 | 角色性别，影响部分功法选择 | 男/女 |
| **资质属性** | 根骨 | 修炼资质，影响修炼速度 | 1-100 |
| | 悟性 | 学习能力，影响功法掌握速度 | 1-100 |
| | 福缘 | 运气值，影响奇遇概率 | 1-100 |
| | 心性 | 心理素质，影响突破成功率 | 1-100 |
| **性格属性** | 野心 | 权力欲望，影响决策倾向 | 1-100 |
| | 勤勉 | 勤奋程度，影响工作效率 | 1-100 |
| | 忠诚 | 对宗门忠诚度 | 1-100 |
| | 善良 | 道德倾向，影响社交行为 | 1-100 |

#### 2.2.4 角色行为类型

| 行为类型 | 执行频率 | 主要参与者 | 行为效果 |
|---------|---------|---------|---------|
| **修炼行为** | 日常 | 所有角色 | 提升修为，突破境界 |
| **管理行为** | 定期 | 管理层角色 | 制定政策，分配资源 |
| **工作行为** | 按需 | 技术型角色 | 执行专业任务，产出资源 |
| **社交行为** | 随机 | 所有角色 | 建立关系，影响决策 |
| **决策行为** | 关键节点 | 管理层角色 | 影响宗门发展方向 |

#### 2.2.5 决策系统特性
- **目标导向**：基于角色当前目标和优先级进行决策
- **环境适应**：能够根据宗门状况调整行为策略
- **权限分级**：不同层级角色具有不同的决策权限
- **学习能力**：角色能够从经验中学习并改进决策

### 2.3 宗门管理系统
宗门管理系统负责管理宗门的组织结构、资源分配和设施建设，是游戏世界运行的基础框架。

#### 2.3.1 宗门层级结构

| 层级 | 角色类型 | 数量 | 主要职责 | 管理权限 |
|-----|---------|-----|---------|---------|
| **核心管理层** | 掌门 | 1 | 最高决策、战略制定 | 全权管理 |
| | 长老 | 3-8 | 专项事务管理 | 分管领域 |
| | 亲传弟子 | 10-30 | 重要任务执行 | 管理内门弟子 |
| | 内门弟子 | 50-200 | 基础管理修炼 | 自身资源使用 |
| **资源层** | 外门弟子 | 200-1000 | 人才储备、基础工作 | 有限资源使用 |
| | 宗门杂役 | 500-5000 | 劳动力提供 | 基础生存保障 |
| | 凡俗百姓 | 10000+ | 基础资源产出 | 基本生存需求 |

#### 2.3.2 管理层职责与权限

| 职务 | 职责范围 | 资源调配权限 | 管理范围 | 决策权重 |
|-----|---------|-------------|---------|---------|
| **掌门** | 全宗事务 | 无限制 | 所有角色 | 100% |
| **执法长老** | 纪律执法 | 执法资源 | 执法弟子 | 15% |
| **炼丹长老** | 丹药炼制 | 炼丹资源 | 炼丹弟子 | 15% |
| **炼器长老** | 装备打造 | 炼器资源 | 炼器弟子 | 15% |
| **传功长老** | 功法传授 | 功法资源 | 传功弟子 | 15% |
| **财务长老** | 财务管理 | 资金资源 | 财务弟子 | 15% |

#### 2.3.3 资源层产出机制

| 资源类型 | 产出角色 | 年产出量 | 主要用途 | 价值评估 |
|---------|---------|---------|---------|---------|
| **基础资源** | 凡俗百姓 | 粮食：1.2石/人<br>布料：0.8匹/人 | 维持生存 | 基础价值 |
| **劳动力** | 宗门杂役 | 1单位/人 | 设施建设维护 | 中等价值 |
| **人才储备** | 外门弟子 | 潜在人才 | 选拔内门弟子 | 高价值 |

#### 2.3.4 人口资源系统
**人口类型**：
- **凡俗百姓**：通过区域占领获得的平民百姓，是宗门人口资源的基础，提供主要基础资源产出
- **宗门杂役**：从凡俗百姓中招募或转化的底层人员，提供劳动力
- **外门弟子**：从凡俗百姓或宗门杂役中选拔的有资质人员，作为人才储备

**人口管理**：
- **人口数量**：主要通过占领新区域获得凡俗百姓，同时受人口自然增长和流失影响
- **人口质量**：人口的平均资质和素质，影响资源产出效率和弟子选拔质量
- **人口忠诚度**：人口对宗门的忠诚度，影响稳定度、产出和弟子招募成功率

**人口产出**：
- **基础资源**：凡俗百姓每年提供粮食、布料等基础物资，产出公式为：年产出 = 人口数量 × 人均产出率 × 设施加成
- **劳动力**：宗门杂役提供劳动力，用于设施建设和维护，每个宗门杂役提供1单位劳动力
- **人才储备**：外门弟子中可能出现有潜力的人才，可选拔为内门弟子，选拔概率与外门弟子数量和资质相关

#### 2.3.5 资源管理
**基础资源**：
- **生存资源**：
  - **粮食**：维持宗门人口生存的基础资源，主要从农田产出
  - **布料**：制作衣物和日常用品的基础材料
- **建设资源**：
  - **木材**：建筑和设施建设的基础材料
  - **矿石**：金属制品和高级设施的基础材料
- **修炼资源**：
  - **灵石**：修炼和阵法运行的基础能量来源
  - **灵草**：炼丹和制药的基础材料

**资源分配与货币体系**：
- **灵石使用场景**：
  - 外部交易：与其他宗门交易、购买外部资源
  - 高级资源：炼制高级丹药、打造高级装备
  - 设施建设：建设高级设施、升级现有设施
  - 外部雇佣：雇佣外部修士、购买外部服务
- **贡献点使用场景**：
  - 内部资源：购买宗门内部资源、丹药、功法
  - 设施使用：使用炼丹房、炼器房、修炼室等设施
  - 功法学习：学习宗门功法、查阅藏经阁
  - 职务晋升：满足职务晋升的贡献点要求

#### 2.3.6 宗门贡献机制（内部货币系统）
**双货币体系示意图**

```
┌─────────────────────────────────────────────────────────────┐
│                       双货币体系                            │
├─────────────────────────────────────────────────────────────┤
│ 灵石 (Spirit Stones)             贡献点 (Contribution Points) │
│ • 游戏世界通用货币                 • 宗门内部专用货币          │
│ • 外部交易、高级资源购买           • 内部资源分配、设施使用     │
│ • 角色工资、修炼消耗               • 功法学习、职务晋升         │
│ • 可自由流通                      • 宗门内部流通              │
└─────────────────────────────┬─────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   兑换系统 (浮动汇率)                        │
│ 1块灵石 ≈ 10-100贡献点 (根据宗门经济状况浮动)                 │
└─────────────────────────────────────────────────────────────┘
```

**贡献点获取渠道**：
- 任务完成：完成宗门任务获得贡献点
- 试炼成果：成功完成试炼获得贡献点
- 资源贡献：向宗门捐献资源获得贡献点
- 设施建设：参与设施建设获得贡献点
- 人才培养：培养优秀弟子获得贡献点
- 灵石兑换：可用灵石兑换贡献点

**贡献点用途**：
- 功法学习权限：不同贡献点可学习不同级别功法
- 职务晋升：贡献点是职务晋升的重要条件
- 设施使用：使用宗门设施需要消耗贡献点
- 资源购买：内部资源分配使用贡献点

#### 2.3.7 灵石经济模型
**灵石经济循环示意图**

```
┌─────────────────────────────────────────────────────────────┐
│                     灵石经济循环                            │
├─────────────────────────────────────────────────────────────┤
│ 产出机制 (Income)              → 消耗机制 (Expenditure)      │
│ • 灵脉产出 (主要)               • 角色修炼消耗                │
│ • 区域占领收益                 • 职务工资支出                │
│ • 试炼奖励                     • 设施运行消耗                │
│ • 交易获取                     • 炼制材料消耗                │
│ • 特殊事件                     • 维护成本                    │
├─────────────────────────────────────────────────────────────┤
│ 转移机制 (Transfer)             → 平衡机制 (Balance)          │
│ • 交易转移                     • 供需平衡调节                │
│ • 工资发放                     • 价格调节机制                │
│ • 贡献点兑换                   • 储备管理策略                │
└─────────────────────────────────────────────────────────────┘
```

**灵石产出机制**：
- **灵脉产出（主要来源）**：每平方公里每年产出500-20000块灵石（根据灵脉品质）
- **区域占领收益**：占领灵脉区域自动获得灵石产出
- **试炼奖励**：完成试炼获得灵石奖励
- **交易获取**：出售资源、提供服务换取灵石
- **特殊事件**：灵脉发现、遗迹探索等获得灵石

**灵石消耗机制**：
- **角色修炼消耗**：不同境界每年消耗100-80000块灵石
- **职务工资支出**：不同职务每年消耗200-3000块灵石
- **设施运行消耗**：炼丹房、炼器房等设施消耗灵石
- **炼制材料消耗**：高级丹药和法宝炼制需要灵石

**灵石总量守恒原则**：
- 除实际消耗外，灵石在游戏世界中总量基本守恒
- 灵石转移只是改变所有权，不会减少总量
- 实际消耗的灵石会从游戏世界中永久消失

#### 2.3.8 设施建设
- **基础设施**：主殿、山门、弟子居、伙房
- **功能设施**：修炼室、炼丹房、炼器阁、藏经阁、阵法堂
- **生产设施**：农田、矿场、工坊（用于提升资源产出效率）
- **防御设施**：护山大阵、哨塔、地牢
- **升级系统**：设施可通过消耗资源进行升级，提升功能效果和资源产出

### 2.4 道具系统
道具系统管理游戏中的所有物品，包括丹药、材料、装备和功法秘籍，是资源流通和角色强化的核心。

#### 2.4.1 道具分类体系

| 道具类别 | 子类别 | 主要功能 | 获取方式 | 外部价值（灵石） |
|---------|---------|---------|---------|-----------------|
| **丹药类** | 基础丹药 | 恢复、治疗 | 炼制 | 10-300灵石 |
| | 中级丹药 | 修炼辅助 | 炼制 | 200-800灵石 |
| | 高级丹药 | 突破辅助 | 炼制 | 1000-8000灵石 |
| **材料类** | 基础材料 | 基础炼制 | 采集 | 10-100灵石 |
| | 高级材料 | 高级炼制 | 试炼 | 500-15000灵石 |
| **装备类** | 武器 | 攻击增强 | 打造/试炼 | 50-100000灵石 |
| | 防具 | 防御增强 | 打造/试炼 | 30-200000灵石 |
| | 饰品 | 属性提升 | 打造/试炼 | 200-100000灵石 |

#### 2.4.2 丹药类道具详细规格

| 丹药名称 | 品级 | 炼制材料 | 效果描述 | 价值范围 |
|---------|-----|---------|---------|---------|
| 回气丹 | 基础 | 灵草×10+灵石×5 | 恢复灵气100-200点 | 10-20灵石 |
| 疗伤丹 | 基础 | 灵草×15+灵石×8 | 恢复生命200-300点 | 15-25灵石 |
| 聚气丹 | 中级 | 灵草×30+灵石×20 | 修炼速度+20%持续2小时 | 50-80灵石 |
| 筑基丹 | 中级 | 灵草×50+灵石×100 | 筑基成功率+15% | 200-300灵石 |
| 金丹丸 | 高级 | 灵草×100+灵石×500+金丹草×5 | 金丹成功率+10% | 1000-1500灵石 |

#### 2.4.3 装备稀有度体系

| 稀有度 | 武器攻击力 | 防具防御力 | 制作材料 | 价值范围 |
|---------|---------|---------|---------|---------|
| 凡器 | 10-30 | 5-15 | 基础矿石+木材 | 50-300灵石 |
| 法器 | 50-100 | 30-60 | 灵铁+灵石 | 300-1500灵石 |
| 灵器 | 150-300 | 80-150 | 星辰铁+灵石 | 1500-5000灵石 |
| 仙器 | 500-1000 | 300-600 | 仙金+灵石 | 5000-20000灵石 |
| 神器 | 2000-5000 | 1000-2000 | 神级材料 | 20000-100000灵石 |

#### 2.4.4 装备升级系统
- **升级机制**：神器级别装备无法直接打造，只能通过升级现有装备获得
- **升级材料**：需要消耗大量高级材料和低级装备作为喂养材料
- **升级成功率**：与材料品质、角色技能、装备基础有关
- **升级效果**：装备基础属性大幅提升，特效增强，可能获得新特性

#### 2.4.5 道具流通机制
- **基础交易货币**：灵石作为所有道具交易的基础货币
- **交易方式**：宗门内部交易、外部交易、拍卖系统
- **价格波动**：受供需关系、炼制难度、稀有程度影响
- **自动流通**：AI角色根据需求自动进行道具交易

### 2.5 试炼系统
试炼系统是一个多层次的游戏系统，为AI角色提供获取高级材料道具的主要途径。

#### 2.5.1 试炼系统概述
- **核心定位**：通过占领区域解锁试炼机会，产出道具系统中的高级材料道具
- **试炼类型**：小区域随时试炼、大区域高级试炼、宗门定期试炼
- **试炼目标**：获取高级材料、装备、功法秘籍等

#### 2.5.2 试炼层次结构
- **小区域随时试炼**：
  - 随时可进行，无冷却时间
  - 低风险低收益，主要产出基础材料
- **大区域高级试炼**：
  - 需要完全占领整个大区域才能解锁
  - 高风险高收益，产出特定区域特色材料
  - 有冷却时间限制
- **宗门定期试炼**：
  - 宗门定期组织大型试炼活动
  - 多个AI角色可同时参与
  - 提升宗门声望和凝聚力

#### 2.5.3 试炼产出机制
- **高级材料道具产出**：主要产出各种高级材料道具
- **低级装备道具产出**：有概率直接获得成品低级装备
- **功法秘籍道具产出**：有概率获得各种功法秘籍
- **特殊奖励道具**：锻造图纸、宗门贡献、修为提升等

#### 2.5.4 试炼材料分类系统
- **基础材料类（小区域随时试炼产出）**：
  - 灵草材料、矿石材料、妖兽材料
- **高级材料类（大区域高级试炼产出）**：
  - 灵脉材料、古战场材料、秘境材料
- **特色材料类（宗门定期试炼产出）**：
  - 宗门特色材料、联合秘境材料、传承材料

#### 2.5.5 AI角色试炼交互
- **试炼决策机制**：需求评估、风险评估、资源评估、优先级排序
- **试炼准备行为**：道具准备、技能准备、队伍协调、情报收集
- **试炼执行行为**：策略执行、资源管理、风险控制、团队协作
- **试炼后行为**：成果分配、经验总结、报告提交、道具补充

#### 2.5.6 试炼风险与奖励平衡
- **风险机制**：受伤风险、死亡风险、道具损失、时间消耗、修为倒退风险
- **奖励机制**：材料价值、装备价值、技能提升、声望提升
- **平衡机制**：风险收益比、角色适应性、宗门策略、动态调整

### 2.6 功法系统
功法系统是宗门传承和角色修炼的核心系统，包含各种修炼法门和战斗技能。

#### 2.6.1 功法分类体系

| 功法类别 | 子类别 | 主要功能 | 学习要求 | 价值范围 |
|---------|---------|---------|---------|---------|
| **修炼功法** | 基础修炼功法 | 提升修为境界 | 炼气期 | 100-500灵石 |
| | 中级修炼功法 | 突破境界瓶颈 | 筑基期 | 500-2000灵石 |
| | 高级修炼功法 | 提升修为品质 | 金丹期以上 | 2000-8000灵石 |
| **战斗功法** | 剑法类 | 增强攻击能力 | 基础要求 | 200-3000灵石 |
| | 法术类 | 元素攻击技能 | 灵根要求 | 300-5000灵石 |
| | 身法类 | 提升闪避移动 | 基础要求 | 150-2000灵石 |

#### 2.6.2 功法获取机制

| 获取方式 | 获取概率 | 功法品级 | 获取条件 |
|---------|---------|---------|---------|
| 藏经阁学习 | 100% | 基础-中级 | 宗门贡献 |
| 长老传授 | 80-90% | 中级-高级 | 师徒关系 |
| 掌门传承 | 70-85% | 高级-顶级 | 核心弟子 |
| 试炼奖励 | 10-30% | 随机品级 | 试炼完成 |

#### 2.6.3 功法学习机制

| 学习阶段 | 持续时间 | 掌握程度 | 效果加成 |
|---------|---------|---------|---------|
| 领悟阶段 | 1-3天 | 初步理解 | 效果+20% |
| 修炼阶段 | 1-2周 | 基本掌握 | 效果+50% |
| 熟练阶段 | 1-3个月 | 熟练掌握 | 效果+80% |
| 精通阶段 | 半年以上 | 完全精通 | 效果+100% |

#### 2.6.4 功法传承机制

| 传承关系 | 传承成功率 | 传承效果 | 冷却时间 |
|---------|---------|---------|---------|
| 长老→亲传弟子 | 80-95% | 熟练度+30% | 1个月 |
| 亲传弟子→内门弟子 | 60-80% | 熟练度+15% | 2周 |
| 掌门→核心弟子 | 70-90% | 熟练度+25% | 3个月 |
| 藏经阁学习 | 100% | 熟练度+0% | 无 |

### 2.7 地图系统
地图系统管理游戏世界的区域划分、占领机制和资源产出，采用分层结构设计。

#### 2.7.1 地图分层结构

| 层级 | 区域类型 | 数量范围 | 主要功能 |
|-----|---------|---------|---------|
| **大区域** | 灵脉区域、古战场、秘境等 | 5-10个 | 提供高级试炼和特色资源 |
| **小区域** | 灵草区、矿脉区、妖兽区等 | 20-50个 | 提供基础试炼和日常资源 |
| **宗门领地** | 宗门核心区域 | 1个 | 宗门设施和核心管理 |

#### 2.7.2 区域占领机制

| 占领阶段 | 控制程度 | 资源产出 | 占领成本 |
|---------|---------|---------|---------|
| 初步占领 | 0-30% | 基础资源10-30% | 低 |
| 稳定控制 | 30-70% | 基础资源30-70% | 中 |
| 完全控制 | 70-100% | 基础资源70-100% | 高 |
| 完全占领 | 100% | 全部资源+加成 | 极高 |

#### 2.7.3 完全占领加成
- **触发条件**：完全占领一个大区域内的所有小区域
- **加成类型**：
  - 资源产出加成：基础资源产出增加15-30%
  - 设施效率加成：区域内所有设施效率提升10-25%
  - 弟子相关加成：弟子修炼速度提高15-30%
  - 战略加成：宗门声望每月增加2-5点

#### 2.7.4 区域资源产出
- **基础产出机制**：产出量 = 基础产出 × 区域面积系数 × 控制度系数 × 设施加成
- **产出类型细分**：
  - 基础资源：木材、矿石、粮食、水源等
  - 高级资源：灵石、灵草、珍稀矿石等
  - 特殊资源：区域特有资源

### 2.8 核心系统交互关系
**核心系统交互关系图**

```
┌─────────────────────────────────────────────────────────────┐
│                        AI管理层                             │
│  (决策制定、角色控制、资源分配)                             │
└─────────────┬─────────────────────────────────────────────┘
              │
              ▼
┌─────────────┼─────────────┐
│ 设施系统    │ 资源仓库     │ 资源分配系统                    │
│ (建筑管理)  │ (资源存储)   │ (资源调度)                      │
└─────────────┴─────┬───────┘
                    │
                    ▼
┌─────────────┬─────┼─────┬─────────────┐
│ 试炼系统    │ 道具系统   │ 功法系统     │ 地图系统           │
│ (材料获取)  │ (物品管理) │ (技能传承)   │ (区域管理)         │
└─────────────┴─────────────┴─────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────────────────────┐
│                       玩家交互系统                          │
│  (界面操作、命令执行、状态反馈)                             │
└─────────────────────────────────────────────────────────────┘
```

**数据流向图**

```
资源产出 → 资源仓库 → 资源分配 → 角色消耗 → 角色成长
     ↑          ↓          ↓          ↓          ↓
区域占领 ← 设施建设 ← 角色决策 ← 角色管理 ← 玩家指令
```

### 2.9 非功能需求

#### 2.9.1 性能要求
- 游戏运行流畅，无明显卡顿
- 支持同时运行100+ AI角色
- 支持管理10万+人口资源

#### 2.9.2 可扩展性
- 支持添加新的角色类型、行为和事件
- 支持扩展宗门的设施和资源类型
- 支持添加新的区域类型和试炼内容

#### 2.9.3 可维护性
- 代码结构清晰，便于维护和扩展
- 基于ECS框架，组件和系统分离，易于测试
- 模块化设计，各系统相对独立

## 3. 技术架构

### 3.1 ECS框架使用
本项目将基于现有的lko-ecs4框架实现，充分利用其组件化和数据驱动的特性。

#### 3.1.1 核心组件使用

| 组件名称 | 功能描述 | 项目应用 |
|---------|---------|---------|
| **World** | 游戏世界的核心容器 | 作为游戏的主容器，存储所有游戏对象和系统 |
| **Entity** | 游戏中的所有对象 | 表示游戏中的角色、资源、设施、事件等所有对象 |
| **Component** | 实体的属性和数据 | 为实体添加各种属性和数据，如Named、Age、Cultivation等 |
| **Service** | 处理实体的创建、更新和销毁 | 实现各种游戏系统，如角色管理、资源管理、世界更新等 |
| **Query** | 实体查询系统 | 高效查询符合特定条件的实体 |

#### 3.1.2 ECS框架优势
- **性能优化**：数据集中存储，减少缓存失效，提高性能
- **可扩展性**：组件化设计，易于添加新功能和修改现有功能
- **灵活性**：实体可以动态添加和移除组件，改变实体类型
- **可维护性**：系统和数据分离，逻辑清晰，易于维护

### 3.2 主要组件设计

#### 3.2.1 角色相关组件
- **Character**：角色标签组件
- **Named**：角色姓名信息
- **Age**：角色年龄信息
- **Cultivation**：角色修为信息
- **Talent**：角色资质信息
- **Personality**：角色性格信息
- **MemberData**：角色在宗门中的身份、贡献度等信息

#### 3.2.2 宗门相关组件
- **Sect**：宗门标签组件
- **SectConfig**：宗门配置信息
- **SectMoney**：宗门资金信息
- **SectResource**：宗门资源信息
- **Building**：设施标签组件
- **BuildingTypeComponent**：设施类型信息
- **BuildingEfficiency**：设施效率信息

#### 3.2.3 行为相关组件
- **Action**：角色当前行为
- **Goal**：角色目标
- **Decision**：角色决策逻辑
- **Command**：AI管理层下达的指令
- **Goap**：角色目标导向决策系统

#### 3.2.4 道具系统组件
- **Item**：物品标签组件
- **Stackable**：可堆叠物品标签组件
- **Amount**：物品数量信息
- **UnitPrice**：物品单价信息

#### 3.2.5 功法系统组件
- **Technique**：功法标签组件
- **TechniqueNameComponent**：功法名称信息
- **TechniqueGradeComponent**：功法品级信息
- **TechniqueTypeComponent**：功法类型信息
- **TechniqueEffectComponent**：功法效果信息

#### 3.2.6 试炼系统组件
- **Trial**：试炼标签组件
- **TrialTypeComponent**：试炼类型信息
- **TrialDifficulty**：试炼难度信息
- **TrialReward**：试炼奖励信息
- **TrialRisk**：试炼风险信息

#### 3.2.7 地图系统组件
- **Region**：大区域标签组件
- **SubRegion**：小区域标签组件
- **RegionTypeComponent**：区域类型信息
- **Owner**：区域所有者信息
- **ControlLevel**：区域控制程度

### 3.3 主要系统设计

#### 3.3.1 世界系统
- 管理游戏世界的时间、天气和事件
- 定期更新世界状态
- 触发资源消耗和产出的时间节点

#### 3.3.2 AI角色系统
- 控制AI角色的行为和决策
- 处理角色的修炼、工作和社交等行为
- 管理AI管理层的工资发放和资源消耗
- 基于GOAP算法实现角色智能规划

#### 3.3.3 宗门管理系统
- **SectService**：宗门核心服务，管理宗门创建、升级和基本信息
- **SectResourceService**：管理宗门资源的获取、消耗、存储和分配
- **SectMemberService**：管理宗门成员，包括成员角色、贡献度和权限
- **BuildingService**：管理宗门设施的建设、维护、升级和运行

#### 3.3.4 道具系统
- **ItemService**：管理游戏中的各类物品，包括创建、获取和使用
- **InventoryService**：管理角色和宗门的物品背包
- **MoneyService**：管理游戏中的货币系统

#### 3.3.5 功法系统
- **TechniqueService**：管理功法系统，包括学习、修炼和使用
- **TechniqueInheritanceService**：管理功法传承系统

#### 3.3.6 试炼系统
- **TrialService**：管理试炼系统，包括试炼创建、参与和奖励发放
- **TrialPreparationService**：管理试炼准备和风险评估

#### 3.3.7 地图系统
- **MapService**：管理地图的整体结构和状态
- **RegionService**：管理大区域的信息和状态
- **SubRegionService**：管理小区域的占领和资源产出
- **ControlService**：计算区域控制度和完全占领状态

#### 3.3.8 玩家交互系统
- 处理玩家的命令输入
- 提供游戏状态的文字描述
- 展示资源流动和消耗情况
- 支持玩家查看系统互动关系和平衡

## 4. 实现计划

### 4.1 第一阶段：基础框架搭建（1周）
- 基于lko-ecs4框架创建游戏核心引擎
- 实现World、Entity、Component、Service等ECS基础架构
- 创建游戏世界初始化机制，支持基础时间管理

### 4.2 第二阶段：AI角色系统实现（2周）
- 实现角色属性系统（修为、资质、性格等）
- 开发基于GOAP的目标导向决策算法
- 支持角色层级管理（掌门→长老→亲传弟子→内门弟子）
- 实现角色行为系统（修炼、管理、工作、社交等）

### 4.3 第三阶段：宗门世界实现（2周）
- 实现宗门结构管理（核心管理层和资源层）
- 完成人口资源系统（凡俗百姓、宗门杂役、外门弟子）
- 实现资源管理（获取、消耗、分配、转换）
- 完成设施系统（建设、维护、升级、运行）

### 4.4 第四阶段：玩家交互与界面（1周）
- 实现文字命令输入和解析系统
- 开发游戏状态展示界面（宗门状态、角色信息、资源状态）
- 支持玩家决策干预（重要决策投票、直接命令）
- 完成游戏历史记录和回溯功能

### 4.5 第五阶段：测试与优化（1周）
- 功能测试：验证所有核心功能正常运行
- 性能测试：确保100+ AI角色和10万+人口资源的管理效率
- 平衡性测试：调整资源产出和消耗的平衡
- 用户体验优化：改进界面交互和响应速度

## 5. 验收标准

### 5.1 功能验收
- 游戏启动与运行：游戏能够正常启动，无崩溃或严重错误
- AI角色层级控制：实现完整的层级管理，每个层级具有不同的权限和行为模式
- AI自主决策：AI角色能够进行自主决策，决策响应时间<1秒
- 人口资源系统：实现自动产出和维持成本计算
- 资源管理：支持资源的获取、消耗、分配和转换
- 设施系统：设施能够正常建设、维护和升级，提供加成效果
- 地图系统：实现区域分层结构，支持区域占领和控制度管理
- 玩家交互：支持至少20种文字命令，能够查询各类信息

### 5.2 性能验收
- 运行流畅性：游戏运行无卡顿，世界更新周期稳定在1-5秒范围内
- AI角色性能：支持同时运行100+ AI角色，每个角色的决策计算时间<100ms
- 人口资源管理：支持管理10万+人口资源，资源计算和分配响应时间<500ms
- 内存使用：游戏运行内存占用控制在1GB以内

### 5.3 代码验收
- 代码结构清晰，符合ECS框架设计原则
- 组件和系统分离，易于维护和扩展
- 代码注释完善，便于理解

## 6. 技术栈
- **核心框架**：lko-ecs4（项目现有的ECS框架）
- **开发语言**：Kotlin
- **构建工具**：Gradle
- **运行环境**：JVM

## 7. 预期交付时间
项目预计在7周内完成，具体时间安排如下：
- 第一阶段：1周
- 第二阶段：2周
- 第三阶段：2周
- 第四阶段：1周
- 第五阶段：1周
- 总交付时间：7周

## 8. 风险评估

### 8.1 技术风险
- **ECS框架的性能优化**：大量AI角色可能导致性能问题
- **AI决策算法的复杂度**：需要平衡决策质量和性能

### 8.2 功能风险
- **角色行为的多样性**：需要确保AI角色行为丰富且合理
- **世界事件的平衡性**：随机事件需要保持游戏的趣味性和挑战性

### 8.3 应对策略
- 进行性能测试和优化，确保游戏运行流畅
- 迭代开发AI决策算法，逐步提升决策质量
- 收集用户反馈，不断调整游戏平衡

---

**文档版本**：2.1（修正版）
**更新日期**：2025-12-21
**编写人**：AI Assistant