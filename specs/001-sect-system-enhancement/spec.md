# 功能规范: 宗门系统完善

**功能分支**: `001-sect-system-enhancement`
**创建时间**: 2025-12-13
**状态**: 已澄清
**输入**: 用户描述: "完善当前宗门系统，识别需要完善的功能点，包括宗门升级、宗门资源、宗门任务、宗门技能等功能"

## 澄清记录

| 问题 | 领域 | 决定 |
|------|------|------|
| 任务奖励计算方式 | 任务 | 动态公式：基于任务完成时间、完成质量、弟子等级等因素计算 |
| 建筑升级资源消耗 | 建筑 | 多资源指数增长：消耗灵石+特定材料，资源消耗按 基础×1.5^等级 |
| 角色权限划分 | 成员 | 职能分工式：宗主=全权限，长老=管理，内门=任务发布，外门=仅参与 |
| 成员上限与晋升 | 成员 | 分层配额+综合考核：每个角色有独立配额，晋升需满足贡献度+等级+考核任务 |
| 任务类型与并发 | 任务 | 多类型自由并发：任务分4类型（采集/战斗/修炼/探索），弟子可自由并发（上限5个） |

## 现状分析

### 已有功能

当前宗门系统（`SectService`）已实现以下基础功能：

1. **宗门创建**: 支持创建宗门并设置宗主
2. **成员管理**: 添加/移除成员、获取成员列表、更改成员角色（宗主/长老/弟子）
3. **贡献度系统**: 成员可积累贡献度
4. **声望系统**: 宗门可积累声望
5. **等级系统**: 宗门可升级（通过 LevelingService）
6. **建筑系统**: 可创建炼丹房和藏经阁（基础实现）
7. **货币系统**: 宗门拥有货币（Money 组件）

### 与其他系统的集成

- **LevelingService**: 提供实体升级能力
- **MoneyService**: 提供货币转移能力
- **InventoryService**: 提供物品管理能力
- **AttributeService**: 提供属性系统
- **CharacterService**: 提供角色创建能力

## 用户场景与测试 *(必填)*

### 用户故事 1 - 宗门资源管理 (优先级: P1)

作为宗门管理者，我希望能够管理宗门的各种资源（如灵石、灵草、丹药等），以便合理分配资源支持宗门发展和弟子修炼。

**优先级原因**: 资源是宗门运营的基础，所有其他功能（任务奖励、建筑升级、福利发放）都依赖于资源系统。

**独立测试**: 可以通过创建宗门、存入资源、查看资源余额、取出资源来完全测试，交付宗门资源存储和管理的核心价值。

**验收场景**: 

1. **给定** 一个已创建的宗门, **当** 管理者向宗门仓库存入 100 灵石时, **那么** 宗门资源中灵石数量增加 100
2. **给定** 宗门仓库有 100 灵石, **当** 管理者取出 30 灵石时, **那么** 宗门资源中灵石数量减少为 70
3. **给定** 宗门仓库有 50 灵石, **当** 管理者尝试取出 100 灵石时, **那么** 系统提示资源不足，操作失败

---

### 用户故事 2 - 宗门任务系统 (优先级: P1)

作为弟子，我希望能够领取宗门发布的任务并完成后获得奖励，以便获取贡献度和资源来提升自己。

**优先级原因**: 任务系统是弟子与宗门互动的核心机制，也是贡献度获取的主要途径。

**独立测试**: 可以通过创建任务、弟子领取任务、完成任务、获得奖励来完全测试，交付任务驱动的宗门互动价值。

**验收场景**: 

1. **给定** 宗门有一个采药任务, **当** 弟子领取该任务时, **那么** 任务状态变为进行中，弟子的任务列表显示该任务
2. **给定** 弟子正在进行采药任务, **当** 弟子提交任务所需物品时, **那么** 任务完成，弟子获得贡献度奖励
3. **给定** 弟子正在进行任务, **当** 弟子放弃任务时, **那么** 任务返回任务池，弟子可重新领取

---

### 用户故事 3 - 宗门建筑升级 (优先级: P2)

作为宗门管理者，我希望能够升级宗门建筑，以便提升建筑的产出效率和容量。

**优先级原因**: 建筑升级是宗门发展的重要表现，影响整体生产效率，但依赖于资源系统。

**独立测试**: 可以通过创建建筑、满足升级条件、执行升级、查看升级效果来完全测试，交付建筑成长的价值。

**验收场景**: 

1. **给定** 一个 1 级炼丹房, **当** 满足升级条件（资源、宗门等级等）并执行升级时, **那么** 炼丹房升级为 2 级
2. **给定** 一个 2 级炼丹房, **当** 宗门等级不足时尝试升级, **那么** 系统提示宗门等级不足，升级失败
3. **给定** 一个升级后的炼丹房, **当** 进行炼丹时, **那么** 炼丹效率/成功率有所提升

---

### 用户故事 4 - 宗门技能/功法传授 (优先级: P2)

作为弟子，我希望能够从宗门藏经阁学习功法和技能，以便提升自己的战斗能力和修炼效率。

**优先级原因**: 功法系统是弟子成长的重要途径，增加宗门对弟子的吸引力。

**独立测试**: 可以通过添加功法到藏经阁、弟子学习功法、验证弟子获得功法效果来完全测试，交付知识传承的价值。

**验收场景**: 

1. **给定** 藏经阁有《基础剑法》, **当** 弟子消耗贡献度学习该功法时, **那么** 弟子获得该功法
2. **给定** 弟子贡献度不足, **当** 弟子尝试学习功法时, **那么** 系统提示贡献度不足，学习失败
3. **给定** 功法有等级要求, **当** 弟子等级不满足时尝试学习, **那么** 系统提示等级不足，学习失败

---

### 用户故事 5 - 宗门升级奖励 (优先级: P3)

作为宗门成员，我希望在宗门升级时获得相应的奖励和解锁新功能，以便享受宗门发展带来的福利。

**优先级原因**: 升级奖励增加宗门发展的成就感，但属于锦上添花的功能。

**独立测试**: 可以通过宗门升级、验证奖励发放、检查新功能解锁来完全测试，交付成长激励的价值。

**验收场景**: 

1. **给定** 宗门即将升级到 2 级, **当** 宗门经验达到升级要求时, **那么** 宗门升级，所有成员收到通知
2. **给定** 宗门升级到 2 级, **当** 升级完成时, **那么** 解锁新建筑类型（如练功房）
3. **给定** 宗门升级到 3 级, **当** 升级完成时, **那么** 建筑容量上限提升

---

### 用户故事 6 - 宗门福利发放 (优先级: P3)

作为宗门成员，我希望定期获得宗门发放的福利，以便获取修炼资源。

**优先级原因**: 福利系统增加弟子留存动机，但可以后期完善。

**独立测试**: 可以通过设置福利规则、触发福利发放、验证成员收到福利来完全测试，交付定期激励的价值。

**验收场景**: 

1. **给定** 宗门设定了每日福利规则, **当** 新的一天开始时, **那么** 符合条件的成员自动获得福利
2. **给定** 福利规则根据成员角色不同, **当** 福利发放时, **那么** 长老获得比弟子更多的福利
3. **给定** 成员今日已领取福利, **当** 再次尝试领取时, **那么** 系统提示今日已领取

---

### 边界情况

- 当宗门资源耗尽时，依赖资源的操作（建筑升级、福利发放）如何处理？系统应该阻止操作并给出明确提示。
- 当宗门成员同时领取同一任务时，系统如何处理？任务应有领取人数限制或独占机制。
- 当宗门被解散时，成员的贡献度和已学功法如何处理？贡献度清零，已学功法保留。
- 当成员退出宗门后重新加入时，之前的贡献度是否保留？不保留，重新从零开始。

## 需求 *(必填)*

### 功能需求

#### 资源管理

- **FR-001**: 系统必须支持宗门拥有多种类型的资源（如灵石、灵草、丹药等）
- **FR-002**: 系统必须支持向宗门仓库存入资源
- **FR-003**: 系统必须支持从宗门仓库取出资源
- **FR-004**: 系统必须在资源不足时阻止取出操作并给出明确提示
- **FR-005**: 系统必须支持查看宗门当前所有资源及数量

#### 任务系统

- **FR-006**: 系统必须支持创建宗门任务，包含任务描述、要求和奖励
- **FR-006a**: 任务必须分类型：采集、战斗、修炼、探索
- **FR-007**: 系统必须支持弟子领取任务
- **FR-007a**: 弟子可自由领取多个任务，但有总任务数上限（默认5个）
- **FR-008**: 系统必须支持任务有领取人数限制
- **FR-009**: 系统必须支持弟子提交任务并验证完成条件
- **FR-010**: 系统必须在任务完成后自动发放奖励（贡献度、资源等）
- **FR-010a**: 奖励采用动态公式计算，基于任务完成时间、完成质量、弟子等级等因素
- **FR-011**: 系统必须支持弟子放弃正在进行的任务
- **FR-012**: 系统必须支持任务有时间限制

#### 建筑升级

- **FR-013**: 系统必须支持建筑拥有等级属性
- **FR-014**: 系统必须定义每个等级的升级条件（资源消耗、宗门等级要求等）
- **FR-014a**: 升级消耗灵石+特定材料，资源消耗按指数增长（基础×1.5^等级）
- **FR-015**: 系统必须在满足条件时允许建筑升级
- **FR-016**: 系统必须在升级后提升建筑的相关属性（效率、容量等）

#### 功法/技能系统

- **FR-017**: 系统必须支持将功法添加到藏经阁
- **FR-018**: 系统必须支持功法有学习要求（贡献度消耗、等级要求等）
- **FR-019**: 系统必须支持弟子学习功法
- **FR-020**: 系统必须在学习成功后将功法添加到弟子的已学列表

#### 升级奖励

- **FR-021**: 系统必须在宗门升级时触发升级事件
- **FR-022**: 系统必须根据新等级解锁相应功能（新建筑类型、容量提升等）
- **FR-023**: 系统必须通知所有成员宗门升级消息

#### 福利系统

- **FR-024**: 系统必须支持定义福利发放规则（频率、数量、条件等）
- **FR-025**: 系统必须根据成员角色差异化福利数量
- **FR-026**: 系统必须记录成员福利领取状态，防止重复领取

#### 成员管理增强

- **FR-027**: 系统必须支持角色职能分工式权限：
  - 宗主：全部权限
  - 长老：管理权限（审批成员、管理建筑、发布任务）
  - 内门弟子：任务发布权限
  - 外门弟子：仅参与权限（领取任务、学习功法）
- **FR-028**: 系统必须支持分层成员配额：
  - 长老配额上限（默认≤5）
  - 内门弟子配额上限（默认≤20）
  - 外门弟子配额随宗门等级提升
- **FR-029**: 系统必须支持综合考核晋升机制：
  - 晋升需满足贡献度阈值
  - 晋升需满足弟子等级要求
  - 晋升需完成指定考核任务
  - 晋升需长老/宗主审批

### 关键实体

- **宗门 (Sect)**: 代表一个修仙门派，包含名称、等级、声望、资源库存，与成员有从属关系，与建筑有拥有关系
- **宗门资源 (SectResource)**: 代表宗门拥有的资源，包含资源类型和数量，属于宗门
- **宗门任务 (SectTask)**: 代表宗门发布的任务，包含任务描述、要求条件、奖励内容、时间限制、领取状态，属于宗门
- **任务进度 (TaskProgress)**: 代表弟子执行任务的进度，关联任务和弟子，记录领取时间和完成状态
- **建筑 (Building)**: 代表宗门的功能性建筑，包含建筑类型、等级、属性加成，属于宗门
- **功法 (Technique)**: 代表可学习的修炼方法或技能，包含名称、描述、学习要求、效果，存放于藏经阁
- **福利规则 (WelfareRule)**: 代表福利发放的规则定义，包含发放频率、数量、角色条件，属于宗门
- **福利记录 (WelfareRecord)**: 代表成员领取福利的记录，关联成员和规则，记录领取时间

### 假设

基于行业标准和游戏设计惯例，做出以下假设：

1. **资源类型**: 默认支持灵石（货币）、灵草（炼丹材料）、丹药（消耗品）三种基础资源类型，后续可扩展
2. **任务类型**: 支持采集、战斗、修炼、探索四种任务类型，弟子可自由并发领取多个任务（上限5个）
3. **任务奖励**: 采用动态公式计算，考虑完成时间、完成质量、弟子等级等因素
4. **建筑上限**: 默认每种建筑类型在宗门中只能存在一个，可通过升级提升容量
5. **建筑升级**: 消耗灵石+特定材料，资源消耗按指数增长（基础×1.5^等级）
6. **福利周期**: 默认福利按日结算，成员每日可领取一次
7. **功法学习**: 默认功法学习不消耗功法本体，功法可被多人学习
8. **成员配额**: 分层配额制（长老≤5，内门≤20，外门随宗门等级提升）
9. **角色权限**: 职能分工式（宗主=全权限，长老=管理，内门=任务发布，外门=仅参与）
10. **晋升机制**: 综合考核制（贡献度+等级+考核任务+审批）

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 宗门管理者可以在 30 秒内完成一次资源存取操作
- **SC-002**: 弟子可以在 1 分钟内完成任务领取和查看任务详情
- **SC-003**: 建筑升级操作在满足条件时 100% 成功执行
- **SC-004**: 功法学习流程不超过 3 个步骤（选择功法、确认消耗、完成学习）
- **SC-005**: 宗门升级后的解锁内容对所有成员立即生效
- **SC-006**: 福利系统能够准确区分不同角色的福利数量差异
- **SC-007**: 90% 的用户在首次使用时能够独立完成任务领取流程
